<div id="search-wrapper" data-url="/">
  <div id="search-modal">
    <header class="search-header">
      <form class="search-form">
        <div class="search-icon">
          <span class="icon">
            <svg
              aria-hidden="true"
              focusable="false"
              data-prefix="fas"
              data-icon="search"
              role="img"
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 512 512"
            >
              <path
                fill="currentColor"
                d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"
              ></path>
            </svg>
          </span>
        </div>
        <input
          type="search"
          id="search-query"
          placeholder="Search"
          tabindex="0"
        />
      </form>
      <button id="close-search-button" title="Close(Esc)" class="search-icon">
        <span class="icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">
            <path
              fill="currentColor"
              d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"
            ></path>
          </svg>
        </span>
      </button>
    </header>
    <section class="search-section">
      <ul id="search-results">
        <!-- <li class="mb-2">
          <a class="flex items-center px-3 py-2 rounded-md appearance-none bg-neutral-100 dark:bg-neutral-700 focus:bg-primary-100 hover:bg-primary-100 dark:hover:bg-primary-900 dark:focus:bg-primary-900 focus:outline-dotted focus:outline-transparent focus:outline-2" href="${value.item.permalink}" tabindex="0">
            <div class="grow">
              <div class="-mb-1 text-lg font-bold">${value.item.title}</div>
              <div class="text-sm text-neutral-500 dark:text-neutral-400">${value.item.section}<span class="px-2 text-primary-500">&middot;</span>${value.item.date}</span></div>
              <div class="text-sm italic">${value.item.summary}</div>
            </div>
            <div class="ml-2 ltr:block rtl:hidden text-neutral-500">&rarr;</div>
            <div class="mr-2 ltr:hidden rtl:block text-neutral-500">&larr;</div>
          </a>
        </li> -->
      </ul>
    </section>
  </div>
</div>
<script src="https://unpkg.com/fuse.js@6.6.2"></script>
<script>
  var fuse;
  var showButton = document.getElementById("search-button");
  var hideButton = document.getElementById("close-search-button");
  var wrapper = document.getElementById("search-wrapper");
  var modal = document.getElementById("search-modal");
  var input = document.getElementById("search-query");
  var output = document.getElementById("search-results");
  var first = output.firstChild;
  var last = output.lastChild;
  var searchVisible = false;
  var indexed = false;
  var hasResults = false;

  // Listen for events
  showButton.addEventListener("click", displaySearch);
  hideButton.addEventListener("click", hideSearch);
  wrapper.addEventListener("click", hideSearch);
  modal.addEventListener("click", function (event) {
    event.stopPropagation();
    event.stopImmediatePropagation();
    return false;
  });
  document.addEventListener("keydown", function (event) {
    // Forward slash to open search wrapper
    if (event.key == "/") {
      if (!searchVisible) {
        event.preventDefault();
        displaySearch();
      }
    }

    // Esc to close search wrapper
    if (event.key == "Escape") {
      hideSearch();
    }

    // Down arrow to move down results list
    if (event.key == "ArrowDown") {
      if (searchVisible && hasResults) {
        event.preventDefault();
        if (document.activeElement == input) {
          first.focus();
        } else if (document.activeElement == last) {
          last.focus();
        } else {
          document.activeElement.parentElement.nextSibling.firstElementChild.focus();
        }
      }
    }

    // Up arrow to move up results list
    if (event.key == "ArrowUp") {
      if (searchVisible && hasResults) {
        event.preventDefault();
        if (document.activeElement == input) {
          input.focus();
        } else if (document.activeElement == first) {
          input.focus();
        } else {
          document.activeElement.parentElement.previousSibling.firstElementChild.focus();
        }
      }
    }
  });

  // Update search on each keypress
  input.onkeyup = function (event) {
    executeQuery(this.value);
  };

  function displaySearch() {
    if (!indexed) {
      buildIndex();
    }
    if (!searchVisible) {
      document.body.style.overflow = "hidden";
      wrapper.style.visibility = "visible";
      input.focus();
      searchVisible = true;
    }
  }

  function hideSearch() {
    if (searchVisible) {
      document.body.style.overflow = "visible";
      wrapper.style.visibility = "hidden";
      input.value = "";
      output.innerHTML = "";
      document.activeElement.blur();
      searchVisible = false;
    }
  }

  function fetchJSON(path, callback) {
    var httpRequest = new XMLHttpRequest();
    httpRequest.onreadystatechange = function () {
      if (httpRequest.readyState === 4) {
        if (httpRequest.status === 200) {
          var data = JSON.parse(httpRequest.responseText);
          if (callback) callback(data);
        }
      }
    };
    httpRequest.open("GET", path);
    httpRequest.send();
  }

  function buildIndex() {
    var baseURL = wrapper.getAttribute("data-url");
    baseURL = baseURL.replace(/\/?$/, "/");
    fetchJSON(baseURL + "index.json", function (data) {
      var options = {
        shouldSort: true,
        ignoreLocation: true,
        threshold: 0.0,
        includeMatches: true,
        keys: [
          { name: "title", weight: 0.8 },
          { name: "section", weight: 0.2 },
          { name: "summary", weight: 0.6 },
          { name: "content", weight: 0.4 },
        ],
      };
      fuse = new Fuse(data, options);
      indexed = true;
    });
  }

  function executeQuery(term) {
    let results = fuse.search(term);
    let resultsHTML = "";

    if (results.length > 0) {
      results.forEach(function (value, key) {
        resultsHTML =
          resultsHTML +
          `<li class="search-item">
          <a href="${value.item.permalink}" tabindex="0">
            <div class="search-item-content">
              <div class="search-item-title">${value.item.title}</div>
              <div class="search-item-categories">${value.item.categories}<span class="search-item-tags">&middot;</span>${value.item.tags}<span class="search-item-date">&middot;</span>${value.item.date}</span></div>
              
            </div>
            <div class="search-item-link">&rarr;</div>
          </a>
        </li>`;
      });
      hasResults = true;
    } else {
      resultsHTML = "";
      hasResults = false;
    }

    output.innerHTML = resultsHTML;
    if (results.length > 0) {
      first = output.firstChild.firstElementChild;
      last = output.lastChild.firstElementChild;
    }
  }
</script>
